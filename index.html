<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI Chat ‚Äî PT Assistant</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="flex h-screen bg-white text-black">

  <!-- SIDEBAR (hanya tampil di desktop) -->
  <div id="sidebar" class="hidden md:flex flex-col w-64 bg-gray-900 text-white border-r border-gray-800 p-4">
    <div id="logo" class="text-lg font-bold mb-5">PT Company AI</div>

    <button id="newChatBtn" onclick="newChat()"
            class="bg-white text-black w-full py-2 rounded-md font-bold mb-2">
      + Obrolan Baru
    </button>

    <input id="search" type="text" placeholder="Cari obrolan..."
           oninput="searchHistory()"
           class="w-full p-2 rounded-md border border-gray-600 mb-4 bg-gray-800 text-white"/>

    <div id="history" class="flex-1 overflow-y-auto"></div>
  </div>

  <!-- MAIN -->
  <div id="main" class="flex-1 flex flex-col p-5">
    <div id="title" class="text-2xl font-bold mb-4">AI Chat by Cikal</div>

    <div id="chat" class="flex-1 border border-gray-300 rounded-lg p-4 overflow-y-auto bg-gray-50"></div>

    <div id="inputArea" class="flex gap-2 mt-2">
      <input id="input" type="text" placeholder="Tulis pesan..."
             class="flex-1 p-2 border border-gray-400 rounded-md" />

      <button id="uploadBtn" onclick="document.getElementById('fileUpload').click()"
              class="px-4 py-2 bg-gray-600 text-white rounded-md hidden md:inline-block">
        üìÅ Foto
      </button>
      <input id="fileUpload" type="file" accept="image/*" onchange="handleImage(event)" class="hidden">

      <button id="sendBtn" onclick="send()"
              class="px-4 py-2 bg-black text-white rounded-md font-bold">
        Send
      </button>
    </div>
  </div>

<script>
  let history = JSON.parse(localStorage.getItem("chatHistory") || "[]");
  let currentChat = [];
  let pendingImage = null;

  renderHistory();

  function saveHistory() {
    localStorage.setItem("chatHistory", JSON.stringify(history));
  }

  function renderHistory() {
    const box = document.getElementById("history");
    box.innerHTML = "";
    history.forEach((item, i) => {
      const div = document.createElement("div");
      div.className = "p-2 bg-gray-800 text-white rounded-md mb-2 cursor-pointer border border-gray-700";
      div.innerText = item.title;
      div.onclick = () => loadChat(i);
      box.appendChild(div);
    });
  }

  function newChat() {
    if (currentChat.length > 0) {
      history.push({
        title: currentChat[0]?.text.replace(/You: /, "").substring(0, 20) || "Obrolan Baru",
        messages: [...currentChat]
      });
      saveHistory();
    }
    currentChat = [];
    pendingImage = null;
    document.getElementById("chat").innerHTML = "";
    renderHistory();
  }

  function loadChat(i) {
    currentChat = [...history[i].messages];
    document.getElementById("chat").innerHTML = "";
    currentChat.forEach(m => addMessage(m.text, m.cls));
  }

  function searchHistory() {
    const q = document.getElementById("search").value.toLowerCase();
    const box = document.getElementById("history");
    box.innerHTML = "";
    history
      .filter(h => h.title.toLowerCase().includes(q))
      .forEach((h, i) => {
        const div = document.createElement("div");
        div.className = "p-2 bg-gray-800 text-white rounded-md mb-2 cursor-pointer border border-gray-700";
        div.innerText = h.title;
        div.onclick = () => loadChat(i);
        box.appendChild(div);
      });
  }

  function formatMarkdown(text) {
    return text.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");
  }

  async function send() {
    const text = document.getElementById("input").value.trim();
    if (!text && !pendingImage) return;
    document.getElementById("input").value = "";

    if (text) {
      addMessage(text, "you");
      currentChat.push({ text: text, cls: "you" });
    }

    let imageToSend = null;
    if (pendingImage) {
      const img = document.createElement("img");
      img.src = pendingImage;
      img.className = "max-w-xs mb-2 rounded-md";
      document.getElementById("chat").appendChild(img);
      imageToSend = pendingImage;
      pendingImage = null;
    }

    const res = await fetch("http://localhost:3000/ask", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        message: text || "",
        image: imageToSend || null
      })
    });

    const data = await res.json();
    addMessage(data.reply, "ai");
    currentChat.push({ text: data.reply, cls: "ai" });
  }

  function addMessage(msg, cls) {
    const div = document.createElement("div");
    div.className = "msg " + cls + " mb-3 p-3 rounded-lg max-w-[70%] whitespace-pre-wrap";
    if(cls === "ai") div.className += " bg-gray-200 text-black text-left";
    if(cls === "you") div.className += " bg-black text-white text-right ml-auto";
    div.innerHTML = formatMarkdown(msg);
    document.getElementById("chat").appendChild(div);
  }

  function handleImage(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      pendingImage = e.target.result;
      addMessage("Foto siap dikirim.", "you");

      const img = document.createElement("img");
      img.src = pendingImage;
      img.className = "max-w-xs opacity-60 mb-2 rounded-md";
      document.getElementById("chat").appendChild(img);
    };
    reader.readAsDataURL(file);
  }
</script>

</body>
</html>
